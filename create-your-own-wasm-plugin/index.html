<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    
    <meta itemprop="name" content="Create your own wasm plugin | AniLog">
    <meta itemprop="description" content="Creating wasm plugins, is not limited to wasmrun plugins alone, they can be quite useful in distributing as independent modules as well. What’s currently lacking today is an open ecosystem, which is surprising given all the developement is quite open.">

    
    <meta name="twitter:title" content="Create your own wasm plugin | AniLog">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="Creating wasm plugins, is not limited to wasmrun plugins alone, they can be quite useful in distributing as independent modules as well. What’s currently lacking today is an open ecosystem, which is surprising given all the developement is quite open.">
    <meta name="twitter:site" content="@kranirudha">
    <meta name="twitter:creator" content="@kranirudha">
    <meta name="twitter:image:src" content="https://blog.anirudha.dev/twitter.png">

    
    <meta name="og:title" content="Create your own wasm plugin | AniLog">
    <meta name="og:description" content="Creating wasm plugins, is not limited to wasmrun plugins alone, they can be quite useful in distributing as independent modules as well. What’s currently lacking today is an open ecosystem, which is surprising given all the developement is quite open.">
    <meta name="og:image" content="https://blog.anirudha.dev/og.png">
    <meta name="og:url" content="https://blog.anirudha.dev/">
    <meta name="og:site_name" content="AniLog">
    <meta name="og:locale" content="en_GB">
    <meta name="og:type" content="website">

    <link rel="icon" type="image/png" href="/me.png" />

    <title>Create your own wasm plugin | AniLog</title>

    <link rel="stylesheet" href="/assets/main.bundle.css">

    <script>
      // Set theme before page renders to prevent flash
      (function() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') {
          document.documentElement.setAttribute('data-theme', 'light');
        }
      })();
    </script>

    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YGZHVY9TD7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YGZHVY9TD7');
    </script>
    

    
  </head>
  <body class="flex flex-col min-h-screen">
    <header class="sticky top-0 z-50 glass-header">
  <nav class="container mx-auto max-w-5xl px-8 py-3 flex flex-wrap items-center justify-between">
    <div class="flex items-center gap-3">
      <a href="/" class="flex items-center gap-3">
        <img src="/ani.png" alt="AniLog logo" class="w-10 h-10 object-cover">
        <h1 class="text-2xl leading-none m-0">AniLog</h1>
      </a>
    </div>

    <div class="flex items-center gap-6">
      <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
    </div>
  </nav>
</header>
    <main class="container mx-auto max-w-5xl p-8 grow">
      
    <p></p>

    
        <div class="post-cover-image" style="background-image: url('/images/posts/24381ddc-6564-485c-8ef6-df48c93e8362.png');"></div>
    

    <div>
        <h2>Create your own wasm plugin</h2>

        

        
            <p class="excerpt">Creating wasm plugins, is not limited to wasmrun plugins alone, they can be quite useful in distributing as independent modules as well. What’s currently lacking today is an open ecosystem, which is surprising given all the developement is quite open.</p>
        

        
            <div class="mb-2">
                <a class="tag webassembly" href="/tag/webassembly">webassembly</a><a class="tag plugins" href="/tag/plugins">plugins</a><a class="tag rust" href="/tag/rust">rust</a><a class="tag wasm" href="/tag/wasm">wasm</a><a class="tag build-in-public" href="/tag/build-in-public">build-in-public</a><a class="tag wasmrun" href="/tag/wasmrun">wasmrun</a>
            </div>
        

        
            
                <p class="text-sm italic">Created on
                    <span datetime="Wed Sep 10 2025 00:00:00 GMT+0000 (Coordinated Universal Time)">September 10, 2025</span>.</p>
            
        

        <div class="content post">
            
                <hr />

                <h3>Table of Contents</h3>

                <nav class="toc">
                <ol>
                    
                    <li><a href="#creating-your-own-plugin">Creating Your Own Plugin</a>
            
                <ol>
                    
                    <li><a href="#create-a-new-rust-project">Create a New Rust Project</a>
            		</li>

                    <li><a href="#configure-cargo.toml">Configure Cargo.toml</a>
            		</li>

                    <li><a href="#implement-the-plugin-traits">Implement the Plugin Traits</a>
            		</li>

                    <li><a href="#implement-ffi-interface">Implement FFI Interface</a>
            		</li>

                    <li><a href="#(optional)-create-binary">(Optional) Create Binary</a>
            		</li>

                    <li><a href="#build-and-test-locally">Build and Test Locally</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#plugin-distribution">Plugin Distribution</a>
            
                <ol>
                    
                    <li><a href="#publish-to-crates.io">Publish to crates.io</a>
            		</li>

                    <li><a href="#plugin-metadata-in-cargo.toml">Plugin Metadata in Cargo.toml</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#plugin-management">Plugin Management</a>
            
                <ol>
                    
                    <li><a href="#install-and-use-with-wasmrun">Install and Use with Wasmrun</a>
            		</li>

                    <li><a href="#plugin-metadata-management">Plugin Metadata Management</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#plugin-management-commands">Plugin Management Commands</a>
            		</li>

                    <li><a href="#best-practices-for-plugin-development">Best Practices for Plugin Development</a>
            
                <ol>
                    
                    <li><a href="#error-handling">Error Handling</a>
            		</li>

                    <li><a href="#project-detection">Project Detection</a>
            		</li>

                    <li><a href="#dependency-management">Dependency Management</a>
            		</li>

                    <li><a href="#testing">Testing</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#common-issues-and-solutions">Common Issues and Solutions</a>
            
                <ol>
                    
                    <li><a href="#dynamic-library-loading-issues">Dynamic Library Loading Issues</a>
            		</li>

                    <li><a href="#abi-compatibility">ABI Compatibility</a>
            		</li>

                    <li><a href="#memory-management">Memory Management</a>
            		</li>
                </ol>
            		</li>
                </ol>
            </nav>

                <hr />
            

            <blockquote>
<p>In this <a href="https://blog.anirudha.dev/rust-plugin-system">first article</a> in this series, we went through all different rust plugins, <a href="https://blog.anirudha.dev/wasmrun-plugin-architecture">the previous one</a>, we understood the wasmrun plugin architecture. Here’s we’ll learn how to create your own wasm plugin which you can run using <a href="https://github.com/anistark/wasmrun">wasmrun</a>.</p>
</blockquote>
<p>Creating wasm plugins, is not limited to wasmrun plugins alone, they can be quite useful in distributing as independent modules as well. What’s currently lacking today is an open ecosystem, which is surprising given all the developement is quite open. Limited is a better word for it rather. So, consider this more of a guide to building your next wasm project, and to get it to work in the larger wasm ecosystem. Making it open or close is upto you. Currently, I’ve only made it work with published crates, however was testing local plugins as well. So, in case you’re also interested in contrubuting, feel free to work on it.</p>
<blockquote>
<p>Plugins were introduced in wasmrun <a href="https://github.com/anistark/wasmrun/releases/tag/v0.8.2">v0.8.2</a> for first time. However, the structural final changes before making it stable only achieved by <a href="https://github.com/anistark/wasmrun/releases/tag/v0.11.3">v0.11.3</a>. So, make sure you’ve the right <a href="https://crates.io/crates/wasmrun">crate</a> version installed.</p>
</blockquote>
<h2 id="creating-your-own-plugin" tabindex="-1">Creating Your Own Plugin</h2>
<p>Creating a wasmrun plugin involves implementing the required traits and exposing them through FFI for external plugins.</p>
<h3 id="create-a-new-rust-project" tabindex="-1">Create a New Rust Project</h3>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Create a new library crate</span><br><span class="token function">cargo</span> new <span class="token parameter variable">--lib</span> wasmcustomlang<br><span class="token builtin class-name">cd</span> wasmcustomlang<br><br><span class="token comment"># Add wasmrun as a dependency</span><br><span class="token function">cargo</span> <span class="token function">add</span> wasmrun</code></pre>
<h3 id="configure-cargo.toml" tabindex="-1">Configure Cargo.toml</h3>
<pre class="language-toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">package</span><span class="token punctuation">]</span><br><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"wasmcustomlang"</span><br><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span><br><span class="token key property">edition</span> <span class="token punctuation">=</span> <span class="token string">"2021"</span><br><span class="token key property">description</span> <span class="token punctuation">=</span> <span class="token string">"Custom language plugin for wasmrun"</span><br><span class="token key property">license</span> <span class="token punctuation">=</span> <span class="token string">"MIT"</span><br><span class="token key property">keywords</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"wasm"</span><span class="token punctuation">,</span> <span class="token string">"webassembly"</span><span class="token punctuation">,</span> <span class="token string">"plugin"</span><span class="token punctuation">,</span> <span class="token string">"wasmrun"</span><span class="token punctuation">]</span><br><br><span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span><br><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"wasmcustomlang"</span><br><span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"cdylib"</span><span class="token punctuation">,</span> <span class="token string">"rlib"</span><span class="token punctuation">]</span>  <span class="token comment"># Both dynamic and static library</span><br><br><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span><br><span class="token key property">wasmrun</span> <span class="token punctuation">=</span> <span class="token string">"0.10"</span><br><span class="token key property">libc</span> <span class="token punctuation">=</span> <span class="token string">"0.2"</span><br><br><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token table class-name">bin</span><span class="token punctuation">]</span><span class="token punctuation">]</span><br><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"wasmrun-wasmcustomlang"</span>  <span class="token comment"># Fallback binary</span><br><span class="token key property">path</span> <span class="token punctuation">=</span> <span class="token string">"src/main.rs"</span></code></pre>
<h3 id="implement-the-plugin-traits" tabindex="-1">Implement the Plugin Traits</h3>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">wasmrun<span class="token punctuation">::</span>plugin<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Plugin</span><span class="token punctuation">,</span> <span class="token class-name">WasmBuilder</span><span class="token punctuation">,</span> <span class="token class-name">PluginInfo</span><span class="token punctuation">,</span> <span class="token class-name">Dependencies</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">wasmrun<span class="token punctuation">::</span>error<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token class-name">Path</span><span class="token punctuation">;</span><br><br><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CustomLangPlugin</span><span class="token punctuation">;</span><br><br><span class="token keyword">impl</span> <span class="token class-name">Plugin</span> <span class="token keyword">for</span> <span class="token class-name">CustomLangPlugin</span> <span class="token punctuation">{</span><br>    <span class="token keyword">fn</span> <span class="token function-definition function">name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">{</span><br>        <span class="token string">"customlang"</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">fn</span> <span class="token function-definition function">supported_extensions</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">{</span><br>        <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"custom"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"cl"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">fn</span> <span class="token function-definition function">can_handle_project</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> project_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>project_path<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"main.custom"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <br>        path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"customlang.toml"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">fn</span> <span class="token function-definition function">get_builder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _project_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">WasmBuilder</span><span class="token operator">>></span> <span class="token punctuation">{</span><br>        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">CustomLangWasmBuilder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">fn</span> <span class="token function-definition function">get_info</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">PluginInfo</span> <span class="token punctuation">{</span><br>        <span class="token class-name">PluginInfo</span> <span class="token punctuation">{</span><br>            name<span class="token punctuation">:</span> <span class="token string">"customlang"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>            version<span class="token punctuation">:</span> <span class="token string">"0.1.0"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>            description<span class="token punctuation">:</span> <span class="token string">"Custom language WebAssembly compiler"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>            author<span class="token punctuation">:</span> <span class="token string">"Your Name &lt;email@example.com>"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>            extensions<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"custom"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"cl"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>            capabilities<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><br>                <span class="token string">"compile"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <br>                <span class="token string">"watch"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                <span class="token string">"web"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            dependencies<span class="token punctuation">:</span> <span class="token class-name">Dependencies</span> <span class="token punctuation">{</span><br>                tools<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"customlang-compiler"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>                optional_tools<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"customlang-optimizer"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CustomLangWasmBuilder</span> <span class="token punctuation">{</span><br>    plugin_info<span class="token punctuation">:</span> <span class="token class-name">PluginInfo</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">impl</span> <span class="token class-name">CustomLangWasmBuilder</span> <span class="token punctuation">{</span><br>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">{</span><br>        <span class="token keyword">Self</span> <span class="token punctuation">{</span><br>            plugin_info<span class="token punctuation">:</span> <span class="token class-name">CustomLangPlugin</span><span class="token punctuation">.</span><span class="token function">get_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">impl</span> <span class="token class-name">WasmBuilder</span> <span class="token keyword">for</span> <span class="token class-name">CustomLangWasmBuilder</span> <span class="token punctuation">{</span><br>    <span class="token keyword">fn</span> <span class="token function-definition function">build</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> project_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> output_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">{</span><br>        <span class="token comment">// Your custom compilation logic here</span><br>        <span class="token keyword">let</span> main_file <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>project_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"main.custom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">let</span> output_file <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>output_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"output.wasm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Example: Call your custom compiler</span><br>        <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>process<span class="token punctuation">::</span></span><span class="token class-name">Command</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"customlang-compiler"</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">[</span><br>                <span class="token string">"--input"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>main_file<span class="token punctuation">.</span><span class="token function">to_string_lossy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                <span class="token string">"--output"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>output_file<span class="token punctuation">.</span><span class="token function">to_string_lossy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                <span class="token string">"--target"</span><span class="token punctuation">,</span> <span class="token string">"wasm32"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">if</span> output<span class="token punctuation">.</span>status<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token class-name">Ok</span><span class="token punctuation">(</span>output_file<span class="token punctuation">.</span><span class="token function">to_string_lossy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token namespace">wasmrun<span class="token punctuation">::</span>error<span class="token punctuation">::</span></span><span class="token class-name">WasmrunError</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Custom lang compilation failed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">fn</span> <span class="token function-definition function">build_for_web</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> project_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> output_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">{</span><br>        <span class="token comment">// Web-specific build logic</span><br>        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>project_path<span class="token punctuation">,</span> output_path<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">fn</span> <span class="token function-definition function">clean</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> project_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span><br>        <span class="token comment">// Clean build artifacts</span><br>        <span class="token keyword">let</span> build_dir <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>project_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"build"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> build_dir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token function">remove_dir_all</span><span class="token punctuation">(</span>build_dir<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">fn</span> <span class="token function-definition function">get_wasm_file</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> project_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">{</span><br>        <span class="token comment">// Return the main WASM file path</span><br>        <span class="token keyword">let</span> wasm_file <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>project_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"build"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"output.wasm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token class-name">Ok</span><span class="token punctuation">(</span>wasm_file<span class="token punctuation">.</span><span class="token function">to_string_lossy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h3 id="implement-ffi-interface" tabindex="-1">Implement FFI Interface</h3>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ffi<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">CString</span><span class="token punctuation">,</span> <span class="token class-name">CStr</span><span class="token punctuation">,</span> c_char<span class="token punctuation">,</span> c_void<span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>ptr<span class="token punctuation">;</span><br><br><span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token constant">GLOBAL_PLUGIN</span><span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">CustomLangPlugin</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">None</span><span class="token punctuation">;</span><br><span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token constant">GLOBAL_BUILDER</span><span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">CustomLangWasmBuilder</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">None</span><span class="token punctuation">;</span><br><br><span class="token comment">// FFI exports for dynamic loading</span><br><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function-definition function">create_wasm_builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">*</span><span class="token keyword">mut</span> c_void <span class="token punctuation">{</span><br>    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><br>        <span class="token constant">GLOBAL_BUILDER</span> <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">CustomLangWasmBuilder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token constant">GLOBAL_BUILDER</span><span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> _ <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> c_void<br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function-definition function">can_handle_project</span><span class="token punctuation">(</span>builder<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> c_void<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> c_char<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> builder<span class="token punctuation">.</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> path<span class="token punctuation">.</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> plugin <span class="token operator">=</span> <span class="token class-name">CustomLangPlugin</span><span class="token punctuation">;</span><br>        <span class="token keyword">let</span> c_str <span class="token operator">=</span> <span class="token class-name">CStr</span><span class="token punctuation">::</span><span class="token function">from_ptr</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>path_str<span class="token punctuation">)</span> <span class="token operator">=</span> c_str<span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            plugin<span class="token punctuation">.</span><span class="token function">can_handle_project</span><span class="token punctuation">(</span>path_str<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>            <span class="token boolean">false</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function-definition function">build_project</span><span class="token punctuation">(</span><br>    builder<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> c_void<span class="token punctuation">,</span> <br>    project_path<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> c_char<span class="token punctuation">,</span> <br>    output_path<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> c_char<br><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">*</span><span class="token keyword">const</span> c_char <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> builder<span class="token punctuation">.</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> project_path<span class="token punctuation">.</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> output_path<span class="token punctuation">.</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token namespace">ptr<span class="token punctuation">::</span></span><span class="token function">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> c_project <span class="token operator">=</span> <span class="token class-name">CStr</span><span class="token punctuation">::</span><span class="token function">from_ptr</span><span class="token punctuation">(</span>project_path<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">let</span> c_output <span class="token operator">=</span> <span class="token class-name">CStr</span><span class="token punctuation">::</span><span class="token function">from_ptr</span><span class="token punctuation">(</span>output_path<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token class-name">Ok</span><span class="token punctuation">(</span>project_str<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>output_str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>c_project<span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c_output<span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> builder_ref <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token punctuation">(</span>builder <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token class-name">CustomLangWasmBuilder</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">=</span> builder_ref<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>project_str<span class="token punctuation">,</span> output_str<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token keyword">let</span> c_result <span class="token operator">=</span> <span class="token class-name">CString</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token keyword">return</span> c_result<span class="token punctuation">.</span><span class="token function">into_raw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>        <span class="token namespace">ptr<span class="token punctuation">::</span></span><span class="token function">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_plugin_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">*</span><span class="token keyword">const</span> c_char <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> plugin <span class="token operator">=</span> <span class="token class-name">CustomLangPlugin</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> info <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">get_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <br>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> c_string <span class="token operator">=</span> <span class="token class-name">CString</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        c_string<span class="token punctuation">.</span><span class="token function">into_raw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token namespace">ptr<span class="token punctuation">::</span></span><span class="token function">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Cleanup function.</span><br><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function-definition function">cleanup_string</span><span class="token punctuation">(</span>ptr<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> c_char<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token operator">!</span>ptr<span class="token punctuation">.</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token class-name">CString</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h3 id="(optional)-create-binary" tabindex="-1">(Optional) Create Binary</h3>
<p>Another easier approach for plugin extensions was to create and distribute the binary. Binaries could have ran independently with no compatibility issues. I prefer binary is secondary, not primary. However, binary are great to test and develop with.</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// src/main.rs</span><br><span class="token keyword">use</span> <span class="token namespace">wasmcustomlang<span class="token punctuation">::</span></span><span class="token class-name">CustomLangPlugin</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">wasmrun<span class="token punctuation">::</span>plugin<span class="token punctuation">::</span></span><span class="token class-name">Plugin</span><span class="token punctuation">;</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token namespace">std<span class="token punctuation">::</span>error<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">>></span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> args<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>env<span class="token punctuation">::</span></span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <br>    <span class="token keyword">if</span> args<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token punctuation">{</span><br>        <span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">"Usage: {} &lt;command> [args...]"</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token namespace">std<span class="token punctuation">::</span>process<span class="token punctuation">::</span></span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">let</span> plugin <span class="token operator">=</span> <span class="token class-name">CustomLangPlugin</span><span class="token punctuation">;</span><br>    <br>    <span class="token keyword">match</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token string">"can-handle"</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>            <span class="token keyword">if</span> args<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token punctuation">{</span><br>                <span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">"Usage: {} can-handle &lt;project-path>"</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token namespace">std<span class="token punctuation">::</span>process<span class="token punctuation">::</span></span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            <span class="token keyword">let</span> can_handle <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">can_handle_project</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> can_handle<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        <span class="token string">"build"</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>            <span class="token keyword">if</span> args<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token punctuation">{</span><br>                <span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">"Usage: {} build &lt;project-path> &lt;output-path>"</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token namespace">std<span class="token punctuation">::</span>process<span class="token punctuation">::</span></span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            <span class="token keyword">let</span> builder <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">get_builder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><br>            <span class="token keyword">let</span> result <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><br>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        <span class="token string">"info"</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> info <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">get_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">let</span> json <span class="token operator">=</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">to_string_pretty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><br>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        _ <span class="token operator">=></span> <span class="token punctuation">{</span><br>            <span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">"Unknown command: {}"</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token namespace">std<span class="token punctuation">::</span>process<span class="token punctuation">::</span></span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<h3 id="build-and-test-locally" tabindex="-1">Build and Test Locally</h3>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Build the plugin</span><br><span class="token function">cargo</span> build <span class="token parameter variable">--release</span><br><br><span class="token comment"># Test that it builds correctly</span><br><span class="token function">cargo</span> <span class="token builtin class-name">test</span><br><br><span class="token comment"># Create a test project</span><br><span class="token function">mkdir</span> test-project<br><span class="token builtin class-name">echo</span> <span class="token string">'fn main() { println!("Hello from CustomLang!"); }'</span> <span class="token operator">></span> test-project/main.custom<br><br><span class="token comment"># Test the plugin locally</span><br><span class="token function">cargo</span> run -- can-handle test-project<br><span class="token function">cargo</span> run -- build test-project ./output<br><span class="token function">cargo</span> run -- info</code></pre>
<h2 id="plugin-distribution" tabindex="-1">Plugin Distribution</h2>
<h3 id="publish-to-crates.io" tabindex="-1">Publish to <a href="https://crates.io">crates</a><a href="http://Crates.io">.io</a></h3>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Login to crates.io</span><br><span class="token function">cargo</span> login<br><br><span class="token comment"># Publish the plugin</span><br><span class="token function">cargo</span> publish</code></pre>
<h3 id="plugin-metadata-in-cargo.toml" tabindex="-1">Plugin Metadata in Cargo.toml</h3>
<p>For better wasmrun integration, you can add wasmrun-specific metadata to your Cargo.toml:</p>
<pre class="language-toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">package.metadata.wasm_plugin</span><span class="token punctuation">]</span><br><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"customlang"</span><br><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span><br><span class="token key property">description</span> <span class="token punctuation">=</span> <span class="token string">"Custom language WebAssembly compiler"</span><br><span class="token key property">author</span> <span class="token punctuation">=</span> <span class="token string">"Your Name &lt;email@example.com>"</span><br><span class="token key property">extensions</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"custom"</span><span class="token punctuation">,</span> <span class="token string">"cl"</span><span class="token punctuation">]</span><br><span class="token key property">entry_files</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"main.custom"</span><span class="token punctuation">,</span> <span class="token string">"customlang.toml"</span><span class="token punctuation">]</span><br><br><span class="token punctuation">[</span><span class="token table class-name">package.metadata.wasm_plugin.capabilities</span><span class="token punctuation">]</span><br><span class="token key property">compile_wasm</span> <span class="token punctuation">=</span> <span class="token boolean">true</span><br><span class="token key property">compile_webapp</span> <span class="token punctuation">=</span> <span class="token boolean">true</span><br><span class="token key property">live_reload</span> <span class="token punctuation">=</span> <span class="token boolean">true</span><br><span class="token key property">optimization</span> <span class="token punctuation">=</span> <span class="token boolean">true</span><br><span class="token key property">custom_targets</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"wasm32-unknown-unknown"</span><span class="token punctuation">]</span><br><span class="token key property">supported_languages</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"customlang"</span><span class="token punctuation">]</span>  <span class="token comment"># Explicit language support declaration</span><br><span class="token comment"># For multi-language plugins: supported_languages = ["rust", "zig"]</span><br><span class="token comment"># If there's variations in same language, better to add each as separate langugage.</span><br><br><span class="token punctuation">[</span><span class="token table class-name">package.metadata.wasm_plugin.dependencies</span><span class="token punctuation">]</span><br><span class="token key property">tools</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"customlang-compiler"</span><span class="token punctuation">]</span><br><span class="token key property">optional_tools</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"customlang-optimizer"</span><span class="token punctuation">]</span><br><br><span class="token punctuation">[</span><span class="token table class-name">package.metadata.wasm_plugin.exports</span><span class="token punctuation">]</span><br><span class="token key property">create_wasm_builder</span> <span class="token punctuation">=</span> <span class="token string">"create_wasm_builder"</span><br><span class="token key property">can_handle_project</span> <span class="token punctuation">=</span> <span class="token string">"customlang_can_handle_project"</span><br><span class="token key property">build</span> <span class="token punctuation">=</span> <span class="token string">"customlang_build"</span><br><span class="token key property">clean</span> <span class="token punctuation">=</span> <span class="token string">"customlang_clean"</span><br><span class="token key property">clone_box</span> <span class="token punctuation">=</span> <span class="token string">"customlang_clone_box"</span><br><span class="token key property">drop</span> <span class="token punctuation">=</span> <span class="token string">"customlang_drop"</span><br><span class="token key property">plugin_create</span> <span class="token punctuation">=</span> <span class="token string">"wasmrun_plugin_create"</span><br><br><span class="token punctuation">[</span><span class="token table class-name">package.metadata.wasm_plugin.frameworks</span><span class="token punctuation">]</span><br><span class="token key property">supported</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"custom-framework"</span><span class="token punctuation">]</span><br><span class="token key property">auto_detect</span> <span class="token punctuation">=</span> <span class="token boolean">true</span></code></pre>
<h2 id="plugin-management" tabindex="-1">Plugin Management</h2>
<h3 id="install-and-use-with-wasmrun" tabindex="-1">Install and Use with Wasmrun</h3>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Install your plugin</span><br>wasmrun plugin <span class="token function">install</span> wasmcustomlang<br><br><span class="token comment"># Use it with a project</span><br>wasmrun ./my-custom-project<br>wasmrun compile ./my-custom-project <span class="token parameter variable">--language</span> customlang</code></pre>
<h3 id="plugin-metadata-management" tabindex="-1">Plugin Metadata Management</h3>
<p>Plugin metadata is stored in several places:</p>
<ul>
<li>
<p><code>~/.wasmrun/plugins/{name}/.wasmrun_metadata</code> - Plugin information</p>
</li>
<li>
<p><code>~/.wasmrun/config.toml</code> - Global plugin registry</p>
</li>
<li>
<p>Plugin’s <code>Cargo.toml</code> - Source metadata</p>
</li>
</ul>
<p>Example metadata file:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"customlang"</span><span class="token punctuation">,</span><br>  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.1.0"</span><span class="token punctuation">,</span> <br>  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Custom language WebAssembly compiler"</span><span class="token punctuation">,</span><br>  <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"Your Name &lt;email@example.com>"</span><span class="token punctuation">,</span><br>  <span class="token property">"extensions"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"custom"</span><span class="token punctuation">,</span> <span class="token string">"cl"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">"entry_files"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"main.custom"</span><span class="token punctuation">,</span> <span class="token string">"customlang.toml"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">"capabilities"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"compile_wasm"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>    <span class="token property">"compile_webapp"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>    <span class="token property">"live_reload"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>    <span class="token property">"optimization"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>    <span class="token property">"custom_targets"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"wasm32-unknown-unknown"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token property">"supported_languages"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"customlang"</span><span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"tools"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"customlang-compiler"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token property">"optional_tools"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"customlang-optimizer"</span><span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h2 id="plugin-management-commands" tabindex="-1">Plugin Management Commands</h2>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># List installed plugins</span><br>wasmrun plugin list<br><br><span class="token comment"># Install a plugin</span><br>wasmrun plugin <span class="token function">install</span> wasmrust<br><br><span class="token comment"># Uninstall a plugin  </span><br>wasmrun plugin uninstall wasmrust<br><br><span class="token comment"># Update a plugin</span><br>wasmrun plugin update wasmrust<br><br><span class="token comment"># Show plugin info</span><br>wasmrun plugin info wasmrust</code></pre>
<h2 id="best-practices-for-plugin-development" tabindex="-1">Best Practices for Plugin Development</h2>
<h3 id="error-handling" tabindex="-1">Error Handling</h3>
<p>Always provide clear error messages and handle edge cases:</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">WasmBuilder</span> <span class="token keyword">for</span> <span class="token class-name">CustomLangWasmBuilder</span> <span class="token punctuation">{</span><br>    <span class="token keyword">fn</span> <span class="token function-definition function">build</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> project_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> output_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">{</span><br>        <span class="token comment">// Validate inputs</span><br>        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>project_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">WasmrunError</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Project path does not exist"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// Check for required tools</span><br>        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token namespace">which<span class="token punctuation">::</span></span><span class="token function">which</span><span class="token punctuation">(</span><span class="token string">"customlang-compiler"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">WasmrunError</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><br>                <span class="token string">"customlang-compiler not found. Please install CustomLang toolchain."</span><br>            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// Your build logic...</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h3 id="project-detection" tabindex="-1">Project Detection</h3>
<p>Make project detection robust and specific:</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">can_handle_project</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> project_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>project_path<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <br>    <span class="token comment">// Check for specific files</span><br>    <span class="token keyword">if</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"customlang.toml"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <br>    <span class="token comment">// Check for file patterns</span><br>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token function">read_dir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> entry <span class="token keyword">in</span> entries<span class="token punctuation">.</span><span class="token function">flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>ext<span class="token punctuation">)</span> <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">extension</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token keyword">if</span> ext <span class="token operator">==</span> <span class="token string">"custom"</span> <span class="token punctuation">{</span><br>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <br>    <span class="token boolean">false</span><br><span class="token punctuation">}</span></code></pre>
<h3 id="dependency-management" tabindex="-1">Dependency Management</h3>
<p>Check for dependencies and provide helpful error messages:</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">check_dependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> <span class="token keyword">mut</span> missing <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <br>    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token namespace">which<span class="token punctuation">::</span></span><span class="token function">which</span><span class="token punctuation">(</span><span class="token string">"customlang-compiler"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        missing<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"customlang-compiler"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <br>    missing<br><span class="token punctuation">}</span></code></pre>
<h3 id="testing" tabindex="-1">Testing</h3>
<p>Write comprehensive tests for your plugin. Try to increase coverage and also check all cases:</p>
<pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[cfg(test)]</span><br><span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span><br>    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span><br>    <span class="token keyword">use</span> <span class="token namespace">tempdir<span class="token punctuation">::</span></span><span class="token class-name">TempDir</span><span class="token punctuation">;</span><br><br>    <span class="token attribute attr-name">#[test]</span><br>    <span class="token keyword">fn</span> <span class="token function-definition function">test_can_handle_project</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> tmp_dir <span class="token operator">=</span> <span class="token class-name">TempDir</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">let</span> project_path <span class="token operator">=</span> tmp_dir<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <br>        <span class="token comment">// Create test file</span><br>        <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token function">write</span><span class="token punctuation">(</span>project_path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"main.custom"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"test content"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <br>        <span class="token keyword">let</span> plugin <span class="token operator">=</span> <span class="token class-name">CustomLangPlugin</span><span class="token punctuation">;</span><br>        <span class="token macro property">assert!</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span><span class="token function">can_handle_project</span><span class="token punctuation">(</span>project_path<span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token attribute attr-name">#[test]</span><br>    <span class="token keyword">fn</span> <span class="token function-definition function">test_plugin_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> plugin <span class="token operator">=</span> <span class="token class-name">CustomLangPlugin</span><span class="token punctuation">;</span><br>        <span class="token keyword">let</span> info <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">get_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <br>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"customlang"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token macro property">assert!</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>extensions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token string">"custom"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h2 id="common-issues-and-solutions" tabindex="-1">Common Issues and Solutions</h2>
<h3 id="dynamic-library-loading-issues" tabindex="-1">Dynamic Library Loading Issues</h3>
<p>When you try to load the plugin, you might encounter an error message saying that the library cannot be found. This issue is quite common and can be frustrating, especially if you’re not sure where things are going wrong. The error typically occurs because the system is unable to locate the necessary library files that the plugin depends on. This can happen if the library paths are not set correctly or if the library files are not named properly. To resolve this issue, you should first double-check that the library search paths are correctly configured. This involves ensuring that the directories where the libraries are stored are included in the system’s library path environment variables. Additionally, make sure that the library files are named correctly according to the system’s conventions. Sometimes, simply renaming a library file to match the expected naming pattern can solve the problem. By taking these steps, you can help the system locate the necessary libraries and successfully load the plugin without any errors.</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// In your plugin loading code</span><br><span class="token keyword">let</span> lib_paths <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><br>    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"lib{}.dylib"</span><span class="token punctuation">,</span> plugin_name<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// macOS</span><br>    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"lib{}.so"</span><span class="token punctuation">,</span> plugin_name<span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">// Linux  </span><br>    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"{}.dll"</span><span class="token punctuation">,</span> plugin_name<span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">// Windows</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<h3 id="abi-compatibility" tabindex="-1">ABI Compatibility</h3>
<p>When a plugin crashes due to an ABI mismatch, it can be quite a headache to deal with. ABI, or Application Binary Interface, refers to the way different program modules communicate at the binary level. If there’s a mismatch, it means that the plugin and the host application are not able to communicate properly, leading to crashes or unexpected behavior. This often happens when the plugin and the application are built with different compiler versions or settings, or when there have been changes in the data structures or function signatures that they use to interact. It’s important to use stable ABI-compatible interfaces. This means designing your plugin and application interfaces in a way that remains consistent across different versions and compiler settings. One effective strategy is to implement version checking. By including version information in your interfaces, you can ensure that the plugin only loads if it matches the expected version of the application. This helps prevent crashes by ensuring that both the plugin and the application are using compatible interfaces. Additionally, it’s a good practice to document any changes in the ABI and communicate these changes to developers who might be using your plugin, so they can make the necessary adjustments on their end.</p>
<pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function-definition function">plugin_abi_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">u32</span> <span class="token punctuation">{</span><br>    <span class="token number">1</span> <span class="token comment">// Increment when ABI changes</span><br><span class="token punctuation">}</span></code></pre>
<h3 id="memory-management" tabindex="-1">Memory Management</h3>
<p>When dealing with memory leaks or crashes at the FFI boundary, it can be quite challenging to pinpoint the exact cause. These issues often arise because of improper handling of memory allocation and deallocation, which can lead to resources not being freed correctly or being accessed after they have been freed. This can cause unexpected behavior or crashes, especially when different languages with different memory management models are involved. It’s crucial to ensure proper memory cleanup and ownership management. This means clearly defining who is responsible for allocating and freeing memory, and sticking to these rules consistently. For example, if your plugin allocates memory, it should also be responsible for freeing it, unless there is a clear agreement that the host application will take over this responsibility. Additionally, using smart pointers or reference counting can help manage ownership and prevent memory leaks. It’s also beneficial to implement thorough testing and debugging practices to catch any memory-related issues early in the development process. By doing so, you can maintain a stable and reliable interface between your plugin and the host application, minimizing the risk of memory leaks or crashes.</p>
<pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function-definition function">cleanup_string</span><span class="token punctuation">(</span>ptr<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> c_char<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token operator">!</span>ptr<span class="token punctuation">.</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token class-name">CString</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Now, you know how to create your very own wasm plugin. Would love to have more community plugins. 🙌</p>
<p><img src="/images/posts/6e8fe806-2f4f-4316-aba5-884d0390fe83.png" alt=""></p>
<p>Even if you’re not building one, if you’ve an idea that you’d like to use, feel free to open an <a href="https://github.com/anistark/wasmrun/issues">issue</a> and let us know about it. 🚀</p>

        </div>

        <div class="article-end">
            <span>✦</span>
            <span>✦</span>
            <span>✦</span>
        </div>

        <div class="post-navigation">
            <div class="post-nav-item post-nav-previous">
                    <a href="/wasmrun-plugin-architecture/">
                        <span class="nav-arrow">←</span>
                        <div class="nav-content">
                            <p class="nav-label">Previous</p>
                            <p class="nav-title">Wasmrun Plugin Architecture</p>
                        </div>
                    </a>
                
            </div>

            <div class="post-nav-item post-nav-next">
                    <a href="/wasmrun-os/">
                        <div class="nav-content">
                            <p class="nav-label">Next</p>
                            <p class="nav-title">Run your code anywhere</p>
                        </div>
                        <span class="nav-arrow">→</span>
                    </a>
                
            </div>
        </div>
    </div>

    </main>
    <footer class="sticky bottom-0 z-50 glass-footer py-4">
  <div class="container mx-auto max-w-5xl px-8 flex items-center justify-between">
    <div class="text-sm">
      Blog by Ani
    </div>

    <div class="flex items-center">
      <a href="https://anirudha.dev" target="_blank" rel="noopener noreferrer" class="footer-icon" aria-label="Home">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
      </a>
    </div>

    <div class="flex items-center gap-4">
      <a href="https://github.com/anistark" target="_blank" rel="noopener noreferrer" class="footer-icon" aria-label="GitHub">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
      </a>
      <a href="https://x.com/kranirudha" target="_blank" rel="noopener noreferrer" class="footer-icon" aria-label="X (Twitter)">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
        </svg>
      </a>
      <a href="https://linkedin.com/in/kranirudha" target="_blank" rel="noopener noreferrer" class="footer-icon" aria-label="LinkedIn">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h4.969v-8.399c0-4.67 6.029-5.052 6.029 0v8.399h4.988v-10.131c0-7.88-8.922-7.593-11.018-3.714v-2.155z"/>
        </svg>
      </a>
    </div>
  </div>
</footer>
    
    <script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
    <script src="/assets/main.bundle.js"></script>
  </body>
</html>
